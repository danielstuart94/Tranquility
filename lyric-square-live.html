<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tqind · Lyric Square, Hammersmith (Live Weather)</title>
  <link rel="icon" href="favicon.ico"/>
  <meta name="description" content="Tqind demo for Lyric Square using live Open‑Meteo weather and air quality."/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:wght@600&family=Nunito+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand-teal:#3A8C82; --brand-grey:#6E6E6E; --brand-sky:#78B9D1;
      --bg:#F9F9F7; --green:#2FBF71; --amber:#F2A900; --red:#E2554D;
      --text:#1c1f24; --muted:#5a616b; --card:#ffffff; --ring-grey:#B8B8B8;
      --focus:#0b6cff; --radius:16px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font:16px/1.6 "Nunito Sans", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;}
    h1,h2,h3{font-family:"Montserrat Alternates","Montserrat Rounded",system-ui; margin:0 0 6px}
    .container{max-width:920px;margin:0 auto;padding:0 16px}
    header{position:sticky;top:0;background:rgba(249,249,247,.9);backdrop-filter:saturate(120%) blur(8px);
      border-bottom:1px solid #e8e8e4; z-index:10}
    .nav{display:flex;align-items:center;justify-content:space-between;padding:10px 0}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:32px;width:32px;border-radius:10px}
    .loc{font-weight:600} .loc small{display:block;font-weight:400;color:var(--muted);font-size:12px}
    a{color:var(--brand-teal);text-decoration:none}
    a:focus,button:focus{outline:3px solid var(--focus);outline-offset:2px}
    section{padding:24px 0}
    .card{background:var(--card);border:1px solid #eee;border-radius:var(--radius);padding:16px}
    .hero{display:grid;grid-template-columns:1fr;gap:16px;align-items:center}
    @media(min-width:720px){.hero{grid-template-columns:220px 1fr}}
    .score-wrap{position:relative; width:220px; height:220px; margin:0 auto}
    .score-svg{transform:rotate(-90deg)}
    .score-num{position:absolute;inset:0;display:grid;place-items:center;font-size:40px;font-weight:700}
    .score-label{position:absolute;left:50%;transform:translateX(-50%);bottom:-6px;font-size:12px;color:var(--muted)}
    .advice{font-size:18px} .meta{font-size:12px;color:var(--muted)}
    .tag{display:inline-block;background:#eef6f5;color:#1f4a46;border-radius:999px;padding:4px 10px;font-size:12px}
    .chart{width:100%;height:180px} .legend{display:flex;gap:10px;align-items:center;font-size:12px;color:var(--muted);margin-top:6px}
    .legend .dot{width:10px;height:10px;border-radius:50%}
    .row{display:grid;gap:16px} @media(min-width:720px){.row{grid-template-columns:1fr 1fr}}
    .icons{display:flex;justify-content:space-between;margin-top:6px} .icons span{font-size:12px;color:var(--muted)}
    .list{display:grid;gap:12px} .item{border:1px solid #eee;border-radius:14px;background:#fff;overflow:hidden}
    .item summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:10px;padding:14px}
    .item summary::-webkit-details-marker{display:none}
    .mini-dot{width:10px;height:10px;border-radius:50%}
    .state-green{background:var(--green)} .state-amber{background:var(--amber)} .state-red{background:var(--red)}
    .item .content{padding:0 14px 14px 14px} .kv{display:flex;gap:10px;flex-wrap:wrap;font-size:14px;color:var(--muted)}
    .actions{margin-top:8px;display:flex;gap:8px}
    .btn{border:1px solid #dde1e6;background:#fafafa;padding:8px 12px;border-radius:12px;font:inherit;cursor:pointer;transition:transform .18s ease,background .18s ease}
    .btn:hover{transform:translateY(-1px);background:#fff} .btn:active{transform:translateY(0)}
    .tips li{margin:6px 0;display:flex;gap:8px;align-items:flex-start} .tips .ico{width:18px}
    .cta{display:flex;flex-direction:column;gap:10px} .cta .group{display:flex;gap:8px;flex-wrap:wrap}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#1f2937;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);opacity:0;pointer-events:none;transition:opacity .2s ease}
    .toast.show{opacity:1}
    footer{border-top:1px solid #e8e8e4;margin-top:20px}
    footer .foot{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:14px 0;color:var(--muted);font-size:13px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px}
    .modal.open{display:flex} .modal .box{background:#fff;color:#111;border-radius:14px;max-width:520px;width:100%;padding:16px;border:1px solid #eee}
    .close{float:right;border:none;background:transparent;font-size:20px;cursor:pointer}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <header role="banner">
    <div class="container nav" aria-label="Top bar">
      <div class="brand">
        <img src="logo.svg" alt="Tqind logo"/>
        <div class="loc" aria-label="Location">Lyric Square, Hammersmith<small>Tqind today</small></div>
      </div>
      <a href="index.html" aria-label="Back to home">Home</a>
    </div>
  </header>

  <main id="main" class="container" role="main">
    <section aria-labelledby="hero-title">
      <div class="hero card">
        <div class="score-wrap" aria-live="polite">
          <svg class="score-svg" viewBox="0 0 220 220" width="220" height="220" role="img" aria-label="Tqind score ring">
            <circle cx="110" cy="110" r="94" fill="none" stroke="var(--ring-grey)" stroke-width="16" opacity="0.35"/>
            <circle id="ring" cx="110" cy="110" r="94" fill="none" stroke="var(--green)" stroke-width="16"
              stroke-linecap="round" stroke-dasharray="590" stroke-dashoffset="590"/>
          </svg>
          <div class="score-num"><span id="score">0</span></div>
          <div class="score-label" id="stateLabel">—</div>
          <div id="offlineLabel" class="tag" style="display:none">offline</div>
        </div>
        <div>
          <h1 id="hero-title">Tqind today</h1>
          <p class="advice" id="advice">Loading best time…</p>
          <div class="meta"><span id="updated">Updated —</span> <span id="aqNote"></span>
            <button id="what" class="btn" style="margin-left:6px" aria-haspopup="dialog" aria-controls="modal">What is Tqind?</button>
          </div>
        </div>
      </div>
    </section>

    <section aria-labelledby="forecast-title">
      <h2 id="forecast-title">24-hour forecast</h2>
      <div class="row">
        <div class="card">
          <svg id="chart" class="chart" role="img" aria-label="Tqind hourly forecast line chart"></svg>
          <div class="legend"><div class="dot" style="background:var(--brand-teal)"></div> Score by hour (0–100)</div>
        </div>
        <div class="card">
          <div class="icons" id="wxIcons" aria-label="Weather and wind"></div>
          <p class="meta">Live from Open‑Meteo; air quality from Open‑Meteo AQ. Attributions on footer.</p>
        </div>
      </div>
    </section>

    <section aria-labelledby="tips-title">
      <h2 id="tips-title">Tips</h2>
      <div class="card">
        <ul class="tips" id="tipsList" aria-label="Visit tips"></ul>
      </div>
    </section>

    <section aria-labelledby="breakdown-title">
      <h2 id="breakdown-title">Breakdown</h2>
      <div class="list" id="breakdownList"></div>
    </section>
  </main>

  <footer role="contentinfo">
    <div class="container foot">
      <div>Data: Open‑Meteo Weather & Air Quality, OpenStreetMap, H&F</div>
      <div>Mission: get Londoners outdoors. <a href="privacy.html">Privacy</a> · <a href="contact.html">Contact</a></div>
    </div>
  </footer>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
    <div class="box">
      <button class="close" aria-label="Close" id="closeModal">×</button>
      <h3 id="modalTitle">What is Tqind?</h3>
      <p id="modalDesc">Tqind blends weather, air quality, greenery, shade and crowding proxies into a 0–100 calm score. This demo uses live weather and air quality only; other factors are placeholders.</p>
    </div>
  </div>

  <script>
  (async function(){
    const lat = 51.4939, lon = -0.2268; // Lyric Square approx
    const tz = 'Europe/London';

    const wxUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,wind_speed_10m,precipitation_probability,uv_index&timezone=${encodeURIComponent(tz)}`;
    const aqUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5,pm10,ozone&timezone=${encodeURIComponent(tz)}`;

    let wx, aq;
    try{
      const [wxa, aqa] = await Promise.all([fetch(wxUrl), fetch(aqUrl)]);
      wx = await wxa.json(); aq = await aqa.json();
    }catch(e){
      console.warn('Live fetch failed, falling back to static sample', e);
    }

    // Build a unified hours array for next 24h from now
    const now = new Date();
    const startIdx = (wx?.hourly?.time||[]).findIndex(t => new Date(t) >= now);
    const hours = Array.from({length: 25}, (_,i)=> i*1); // 0..24
    function at(series, baseIdx, offset){ return series?.[baseIdx+offset] ?? null; }

    // Heuristic scoring per hour
    function scoreHour(temp, wind, precipProb, pm25, uv){
      let s = 88;
      if (temp!==null){ if(temp<2) s-=15; else if(temp<7) s-=8; else if(temp>27) s-=18; else if(temp>23) s-=8; }
      if (wind!==null){ if(wind>14) s-=10; else if(wind>8) s-=5; }
      if (precipProb!==null){ s -= Math.round(precipProb/10)*3; } // up to ~30 off in heavy rain risk
      if (pm25!==null){ if(pm25>35) s-=15; else if(pm25>20) s-=8; }
      if (uv!==null){ if(uv>6) s-=6; else if(uv>3) s-=3; }
      return Math.max(0, Math.min(100, s));
    }

    let forecast = [];
    if (wx && aq && startIdx>=0){
      for (let i=0;i<hours.length;i+=6){ // 0,6,12,18,24 for display
        const t = new Date(wx.hourly.time[startIdx + i] || now);
        const temp = at(wx.hourly.temperature_2m, startIdx, i);
        const wind = at(wx.hourly.wind_speed_10m, startIdx, i);
        const prob = at(wx.hourly.precipitation_probability, startIdx, i);
        const uv = at(wx.hourly.uv_index, startIdx, i);
        const pm25 = at(aq.hourly.pm2_5, startIdx, i);
        const score = scoreHour(temp, wind, prob, pm25, uv);
        forecast.push({ hour: t.getHours(), score, temp, wind, prob, uv, pm25 });
      }
    }else{
      // fallback
      forecast = [{hour:0,score:62},{hour:6,score:71},{hour:12,score:82},{hour:18,score:74},{hour:24,score:68}];
    }

    // Current hour score
    const cur = forecast[0] || {score:75};
    const state = cur.score>=70?'Green':(cur.score>=40?'Amber':'Red');
    const ring = document.getElementById('ring');
    const scoreEl = document.getElementById('score');
    const stateLabel = document.getElementById('stateLabel');

    // Animate ring
    const circumference = 2*Math.PI*94;
    ring.setAttribute('stroke-dasharray', String(circumference));
    ring.setAttribute('stroke-dashoffset', String(circumference));
    ring.setAttribute('stroke', state==='Green'?'var(--green)':state==='Amber'?'var(--amber)':'var(--red)');
    const target = cur.score;
    const t0=performance.now(), dur=900;
    function step(t){
      const k=Math.min(1,(t-t0)/dur);
      const val=Math.round(target*k);
      scoreEl.textContent=String(val);
      const off=circumference*(1 - val/100);
      ring.setAttribute('stroke-dashoffset', String(off));
      if(k<1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
    stateLabel.textContent = state;

    // Advice: choose best 3-hr window with max average score
    let bestStart = 0, bestAvg = -1;
    for(let i=0;i<forecast.length-2;i++){
      const avg = (forecast[i].score + forecast[i+1].score + forecast[i+2].score)/3;
      if(avg>bestAvg){ bestAvg=avg; bestStart=i; }
    }
    const h1 = forecast[bestStart]?.hour ?? 10;
    const h2 = forecast[bestStart+2]?.hour ?? 13;
    document.getElementById('advice').textContent = `Best time to visit: ${String(h1).padStart(2,'0')}:00–${String(h2).padStart(2,'0')}:00.`;
    document.getElementById('updated').textContent = 'Updated ' + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

    // Forecast chart
    const svg = document.getElementById('chart');
    const W = svg.clientWidth || 600, H = svg.clientHeight || 180;
    const pad = 10, x0=pad, x1=W-pad, y0=H-18, y1=12;
    function xFor(i){ return x0 + (x1-x0)*(i/(forecast.length-1)); }
    function yFor(s){ return y0 - (y0-y1)*(s/100); }
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
    // Ticks
    const axis = document.createElementNS('http://www.w3.org/2000/svg','g');
    forecast.forEach((p,i)=>{
      const x=xFor(i);
      const t=document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x', x); t.setAttribute('y', H-2);
      t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','11'); t.setAttribute('fill','#7a7f87');
      t.textContent=String(p.hour);
      axis.appendChild(t);
    });
    svg.appendChild(axis);
    // Line
    const d = forecast.map((p,i)=> (i===0?'M':'L') + xFor(i) + ' ' + yFor(p.score)).join(' ');
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', d); path.setAttribute('fill','none');
    path.setAttribute('stroke','var(--brand-teal)'); path.setAttribute('stroke-width','3'); path.setAttribute('stroke-linecap','round');
    svg.appendChild(path);
    // Dots
    forecast.forEach((p,i)=>{
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx', xFor(i)); c.setAttribute('cy', yFor(p.score));
      c.setAttribute('r','3.5'); c.setAttribute('fill','var(--brand-sky)');
      c.setAttribute('aria-label', `Hour ${p.hour}, score ${p.score}`);
      svg.appendChild(c);
    });

    // Weather icons row
    const icons = document.getElementById('wxIcons');
    icons.innerHTML = forecast.map(p => {
      const wind = p.wind ?? 0, prob = p.prob ?? 0, temp = p.temp ?? 0;
      const i = prob>50 ? '🌧️' : (temp>24 ? '☀️' : (prob>20 ? '🌦️' : '🌤️'));
      return `<span aria-label="${p.hour}:00, temp ${Math.round(temp||0)}°C, wind ${Math.round(wind||0)} m/s, rain ${prob||0}%">${i} ${p.hour}h</span>`;
    }).join('');

    // Tips based on conditions
    const tips = [];
    const mid = forecast.find(p=>p.hour===12) || forecast[2] || cur;
    if ((mid.temp||0) > 24) tips.push("Seek shade 12–15h");
    if ((mid.prob||0) > 40) tips.push("Carry a light rain jacket");
    if ((mid.wind||0) > 10) tips.push("Shelter from wind near buildings");
    if (tips.length<3) tips.push("Market busier 14–18h","Benches near Lyric Theatre");
    const tipsList = document.getElementById('tipsList');
    const ico = ['🕶️','☂️','🌬️','💺','🕒'];
    tips.slice(0,3).forEach((tip,i)=>{
      const li=document.createElement('li');
      li.innerHTML = `<span class="ico" aria-hidden="true">${ico[i]||'ℹ️'}</span><span>${tip}</span>`;
      tipsList.appendChild(li);
    });

    // Breakdown: live weather + AQ, plus placeholders
    const list = document.getElementById('breakdownList');
    const factors = [
      {key:'air', label:'Air quality (PM2.5)', value: (aq?.hourly?.pm2_5?.[startIdx] ?? null), unit:'µg/m³',
        state: v=> v==null? 'amber' : (v<=12?'green': v<=35?'amber':'red'),
        meaning: v=> v==null? 'No data' : (v<=12?'Good':'Elevated') , source:'Open‑Meteo AQ'},
      {key:'temperature', label:'Temperature', value: (wx?.hourly?.temperature_2m?.[startIdx] ?? null), unit:'°C',
        state: v=> v==null? 'amber' : (v>=12 && v<=25 ? 'green' : (v>=7 && v<=27 ? 'amber' : 'red')),
        meaning: v=> v==null? 'No data' : (v>=12 && v<=25 ? 'Comfortable' : v>25 ? 'Warm/Hot' : 'Cool/Cold'), source:'Open‑Meteo'},
      {key:'wind', label:'Wind speed', value: (wx?.hourly?.wind_speed_10m?.[startIdx] ?? null), unit:'m/s',
        state: v=> v==null? 'amber' : (v<=4 ? 'green' : v<=8 ? 'amber' : 'red'),
        meaning: v=> v==null? 'No data' : (v<=4?'Light':'Breezy/Gusty'), source:'Open‑Meteo'},
      {key:'precip', label:'Rain probability', value: (wx?.hourly?.precipitation_probability?.[startIdx] ?? null), unit:'%',
        state: v=> v==null? 'amber' : (v<=20?'green': v<=60?'amber':'red'),
        meaning: v=> v==null? 'No data' : (v<=20?'Unlikely':'Possible/likely'), source:'Open‑Meteo'},
      {key:'uv', label:'UV index', value: (wx?.hourly?.uv_index?.[startIdx] ?? null), unit:'',
        state: v=> v==null? 'amber' : (v<3?'green': v<=6?'amber':'red'),
        meaning: v=> v==null? 'No data' : (v<3?'Low':'Moderate/High'), source:'Open‑Meteo'},
      {key:'green', label:'Green/Nature', value:'Low', unit:'', state: _=>'amber', meaning:_=>'Few trees/soft surfaces', source:'OSM (placeholder)'},
      {key:'shade', label:'Shade/Shelter', value:'Limited', unit:'', state: _=>'amber', meaning:_=>'Direct sun at midday', source:'Survey (placeholder)'},
      {key:'crowd', label:'Crowding', value:'Moderate', unit:'', state: _=>'amber', meaning:_=>'Market busier in afternoon', source:'Observation (placeholder)'}
    ];

    factors.forEach(f=>{
      const state = typeof f.state==='function' ? f.state(f.value) : f.state;
      const meaning = typeof f.meaning==='function' ? f.meaning(f.value) : f.meaning;
      const details = document.createElement('details');
      details.className='item';
      const val = (f.value!=null?f.value:'—') + (f.unit?(' '+f.unit):'');
      details.innerHTML = `
        <summary>
          <span class="mini-dot state-${state}"></span>
          <strong style="flex:1">${f.label}</strong>
          <span class="small">${val}</span>
        </summary>
        <div class="content">
          <div class="kv"><strong>${val}</strong> — ${meaning}</div>
          <div class="kv">Source: <span>${f.source}</span></div>
          <div class="actions" role="group" aria-label="Confirm current status">
            <button class="btn">Still true now? Yes</button>
            <button class="btn">No</button>
          </div>
        </div>`;
      list.appendChild(details);
    });

  })();
  </script>
</body>
</html>